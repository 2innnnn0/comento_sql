# 프로그래머스 과제피드백

1. 고양이와 개는 몇 마리 있을까
# 동물 보호소에 들어온 동물 중 고양이와 개가 각각 몇 마리인지 조회하는 SQL문을 작성해주세요. 
# 이때 고양이CAT를 개DOG보다 먼저 조회해주세요.(디테일)
# 날짜순.
# 2022-01-01 -> 2022-01-02
-- 코드를 입력하세요
-- 
SELECT 
    ANIMAL_TYPE, 
    COUNT(ANIMAL_ID) AS ANIMAL_COUNT -- 동물수
    -- COUNT(1) -- 단순히 숫자를 카운트 하는 것이기 때문에 어떤 값이 들어와도 상관없음. 그래도 명목상, 의미 전달로는 특정 ID를 세는 것이기 때문에 가급적이면 고유하게 "지칭할 수 있는 값(가령, ID)"을 넣는게 좋다.
FROM ANIMAL_INS
GROUP BY 1
ORDER BY 1

2. 동명 동물 수 찾기
# 동물 보호소에 들어온 동물 이름 중 
# "두 번 이상 쓰인 이름"과 "해당 이름이 쓰인 횟수"를 조회(SELECT)하는 SQL문을 작성해주세요. 
# 이때 결과는 이름이 없는 동물은 집계에서 제외하며, 
# 결과는 이름 순으로 조회해주세요.
-- 코드를 입력하세요
SELECT 
    NAME, 
    COUNT(ANIMAL_ID) -- 해당 이름이 쓰인 횟수
FROM 
    ANIMAL_INS
WHERE  -- 이름이 없는 동물은 집계에서 제외하며 (공백과'' vs. NULL 차이)
    (NAME != '' -- 1. 이름에 공백이 들어간 경우(EMPTY CASE) -- 오류에 해당
     OR NAME IS NOT NULL) -- 2. 이름자체값이 입력이 안된 경우(NULL CASE)
GROUP BY 
    NAME
HAVING -- 그룹바이의 조건을 사용하는 용도.
    COUNT(ANIMAL_ID) > 1 -- 두 번 이상 = 한 번 초과
ORDER BY
    NAME ASC -- # 결과는 이름 순으로 조회해주세요.


3. 입양 시각 구하기(1)
# 보호소에서는 몇 시에 입양이 가장 활발하게 일어나는지 알아보려 합니다.
# 09:00부터 19:59(20시 전까지. 20시는 포함X)까지, 각 시간대별로 입양이 몇 건이나 발생했는지 조회하는 SQL문을 작성해주세요. 
# 이때 결과는 시간대 순으로 정렬해야 합니다.
# EXTRACT({추출하고자하는 날짜단위} FROM DATETIME) -> EXTRACT 추출할 날짜를 정하기.
# HOUR : 시간추출. MONTH : 월. DAY : 일.
    # EXTRACT(MONTH FROM DATETIME) AS MONTH 

-- # 날짜 표준에 대한 설명.
# 날짜 > 2022-10-23 -> 요일 | 10월의 몇번째주차(53주 - ISO) | 한국공휴일인지도 알 수 있음.
-- https://ko.wikipedia.org/wiki/ISO_8601
-- 새해의 첫번째 주차...?
-- 2021-12-31 -> 2021년의 53주차. & 2022년의 1주차.
-- 2022-01-01 -> 2022년의 1주차.
# 01 주 내 연도의 첫번째 목요일이 존재 (공식 ISO 정의),
# 01 주 내 1월 4일이 존재,
# 시작 연도 내 01 주의 일 대부분(4일 이상)을 가진 첫번째 주, 그리고
# 12월 29일부터 1월 4일까지의 기간 내에 있는 월요일로 시작하는 주.
# 날짜&시간 > 2022-10-23T20:53:14 -> DAY:23 | HOUR : 20 | MINUTUES : 53
SELECT 
    EXTRACT(HOUR FROM DATETIME) as HOUR,
    COUNT(ANIMAL_ID)
FROM ANIMAL_OUTS
WHERE (EXTRACT(HOUR FROM DATETIME) >= 9 
    AND EXTRACT(HOUR FROM DATETIME) < 20)
GROUP BY HOUR
ORDER BY HOUR

4. 입양 시각 구하기(2)
WITH dummy_hour_t AS ( -- 1. 0~23시 더미데이터.
SELECT 
    ROW_NUMBER() OVER(PARTITION BY '') -1 AS HOUR
FROM ANIMAL_OUTS 
LIMIT 24
), animal_out_t AS ( -- 2. 시간대별 입양된 동물의 수. (7~16시. 새벽시간에, 늦은밤 데이터X)
SELECT 
    HOUR(DATETIME) as HOUR,
    COUNT(*) as ANIMAL_COUNT
FROM ANIMAL_OUTS
GROUP BY
    1
)

SELECT 
    dht.HOUR as dummy_hour,
    IFNULL(ANIMAL_COUNT,0) AS ANIMAL_COUNT
FROM dummy_hour_t dht -- 1. 0~23시 더미데이터.(큰)
    LEFT JOIN animal_out_t ao -- 2. 7~19시. 시간대별 입양된 동물의 수.(새벽시간에, 늦은밤 데이터X)
        ON dht.HOUR = ao.HOUR -- 시간으로 연결.
GROUP BY 1,2
ORDER BY 1,2


# 서브쿼리
SELECT 학과명
FROM 학과테이블 
WHERE 학과번호 = (
    SELECT 학과번호
    FROM 학생테이블
    WHERE 학생이름 = '침착맨'
)

SELECT 학과명
FROM 학과테이블 t1
    JOIN 학생테이블 t2
        ON t1.학과번호 = t2.학과번호
WHERE t2.학생이름 = '침착맨'


-- =================================
# 조인을 여러개를 쓰는 케이스 
-- "2000년 이후"의 메달 수상 기록만 고려했을 때, 
-- "메달을 수상"한 올림픽 참가 선수 중 "2개 이상의 국적"으로 메달을 수상한 기록이 있는 선수의 이름을 조회하는 쿼리를 작성해주세요. 
-- 조회된 선수의 이름은 오름차순으로 정렬되어 있어야 합니다.

-- 1. records에 메달 수상한 애들만 있나? -> No, 없는애들도 있더라.
WITH record_with_medal AS (
SELECT 
  id,
  athlete_id,
  game_id,
  event_id,
  team_id
FROM records -- "어떤"(조인 teams,athletes) 선수가 "어떤"(조인games) 경기에서 "어떤"(조인) 메달을 땃다. --> 조인은 어떤이라는 정보의 공백을 채우기 위해 사용하는 기능.
WHERE medal IS NOT NULL -- 무조건 수상한 애들만
)

-- 2. 선수의 국적을 봅시다. -> 2.1 선수별 국적이 두개 이상인 케이스
SELECT
  a.name
  -- COUNT(DISTINCT t.team) -- 국적
FROM record_with_medal rwm
  JOIN teams t -- 국적
    ON rwm.team_id = t.id
  JOIN athletes a -- 선수이름
    ON rwm.athlete_id = a.id
  JOIN games g -- 게임연도
    ON rwm.game_id = g.id
WHERE g.year >= 2000
GROUP BY 1
HAVING COUNT(DISTINCT t.team) > 1 -- 두개이상 국적인 선수들만 뽑기.
ORDER BY a.name 

-- 3. 실제로 살펴보니 동명이인이 있습니다. 최종 답은 다음과 같습니다.
-- 'Chen Jing'
SELECT name
FROM
(
  SELECT
    a.id,
    a.name,
    COUNT(DISTINCT r.team_id) AS team_count
  FROM records r
    JOIN athletes a
    ON r.athlete_id = a.id
    JOIN games g
      ON r.game_id = g.id
  WHERE g.year >= 2000
  AND r.medal IS NOT NULL 
  -- AND a.name = 'Chen Jing'
  GROUP BY 1,2
  HAVING COUNT(DISTINCT r.team_id) >= 2
)
ORDER BY 1




-- 과제 ============================================
-- Q. 정류소별로 가장 마지막에 빌려진 자전거의 대여시각을 구하라.





